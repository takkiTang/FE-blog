# Vue.js æºç åˆ†æä¸‰ï¼šæ·±å…¥å“åº”å¼åŸç†

# Vue.js æºç åˆ†æä¸‰ï¼šæ·±å…¥å“åº”å¼åŸç†

> æœ¬æ–‡åˆ†æçš„ Vue æºç ç‰ˆæœ¬æ˜¯ 2.6.10

ä¸Šä¸€èŠ‚æˆ‘ä»¬è®²åˆ°äº† `initState`,å¦‚æœè¿˜ä¸ç†Ÿæ‚‰å¯ä»¥å‚è€ƒä¹‹å‰å†™çš„ä¸€ç¯‡æ–‡ç«  [ã€ŠVue.js æºç åˆ†æäºŒï¼šinitState åŸç†ã€‹](https://takkitang.github.io/vuesource/2.html),è¿™ä¸€èŠ‚æˆ‘ä»¬é‡ç‚¹èŠä¸€ä¸‹ `Vue.js` æ ¸å¿ƒçš„å“åº”å¼åŸç†ã€‚

åœ¨ vue.js å®˜ç½‘ä¸Šæœ‰ä¸€å¥è¯å†™çš„æ˜¯:

 å½“ä½ æŠŠä¸€ä¸ªæ™®é€šçš„ JavaScript å¯¹è±¡ä¼ å…¥ Vue å®ä¾‹ä½œä¸º `data` é€‰é¡¹ï¼ŒVue å°†éå†æ­¤å¯¹è±¡æ‰€æœ‰çš„å±æ€§ï¼Œå¹¶ä½¿ç”¨ [`Object.defineProperty`](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Object/defineProperty) æŠŠè¿™äº›å±æ€§å…¨éƒ¨è½¬ä¸º [getter/setter](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Guide/Working_with_Objects#å®šä¹‰_getters_ä¸_setters)ã€‚


æ¥ä¸‹æ¥æˆ‘ä»¬äº†è§£ä¸€ä¸‹ `object.defineProperty`

## Object.defineProperty

**`Object.defineProperty()`** æ–¹æ³•ä¼šç›´æ¥åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šå®šä¹‰ä¸€ä¸ªæ–°å±æ€§ï¼Œæˆ–è€…ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„ç°æœ‰å±æ€§ï¼Œ å¹¶è¿”å›è¿™ä¸ªå¯¹è±¡ã€‚

æˆ‘ä»¬æ¥çœ‹çœ‹å®ƒçš„è¯­æ³•ï¼š

```
Object.defineProperty(obj, prop, descriptor)
```

åœ¨è¿™é‡Œæˆ‘ä»¬åªéœ€è¦å…³å¿ƒ `descriptor`çš„ `get` å’Œ `set`,

- get

  ä¸€ä¸ªç»™å±æ€§æä¾› getter çš„æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ getter åˆ™ä¸º `undefined`ã€‚å½“è®¿é—®è¯¥å±æ€§æ—¶ï¼Œè¯¥æ–¹æ³•ä¼šè¢«æ‰§è¡Œï¼Œæ–¹æ³•æ‰§è¡Œæ—¶æ²¡æœ‰å‚æ•°ä¼ å…¥ï¼Œä½†æ˜¯ä¼šä¼ å…¥`this`å¯¹è±¡ï¼ˆç”±äºç»§æ‰¿å…³ç³»ï¼Œè¿™é‡Œçš„`this`å¹¶ä¸ä¸€å®šæ˜¯å®šä¹‰è¯¥å±æ€§çš„å¯¹è±¡ï¼‰ã€‚

- set

  ä¸€ä¸ªç»™å±æ€§æä¾› setter çš„æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ setter åˆ™ä¸º `undefined`ã€‚å½“å±æ€§å€¼ä¿®æ”¹æ—¶ï¼Œè§¦å‘æ‰§è¡Œè¯¥æ–¹æ³•ã€‚è¯¥æ–¹æ³•å°†æ¥å—å”¯ä¸€å‚æ•°ï¼Œå³è¯¥å±æ€§æ–°çš„å‚æ•°å€¼ã€‚

ä¸¾ä¸€ä¸ªğŸŒ°ï¼š

```js
let obj = {}
let initValue = 'hello'
Object.defineProperty(obj,"key",{
    get(){
        console.log('è§¦å‘getå‡½æ•°')
        //å½“è·å–å€¼çš„æ—¶å€™è§¦å‘çš„å‡½æ•°
        return initValue;    
    },
    set(val){
        console.log('è§¦å‘setå‡½æ•°:',val)
        //å½“è®¾ç½®å€¼çš„æ—¶å€™è§¦å‘çš„å‡½æ•°,è®¾ç½®çš„æ–°å€¼é€šè¿‡å‚æ•°valueæ‹¿åˆ°
        initValue = val;
    }
});
//è·å–å€¼
console.log( obj.key );  //hello

//è®¾ç½®å€¼
obj.key = 'change value';

console.log( obj.key ); //change value
```

ç°åœ¨æˆ‘ä»¬äº†è§£äº† `object.defineProperty` çš„ `get` æ˜¯ä¸€ä¸ªç»™å±æ€§æä¾› getter æ–¹æ³• ï¼Œå½“æˆ‘ä»¬è®¿é—®è¯¥å±æ€§æ—¶ä¼šè§¦å‘getteræ–¹æ³•;`set`æ˜¯ç»™å±æ€§æä¾›ä¸€ä¸ª setter æ–¹æ³•ï¼Œå½“æˆ‘ä»¬ä¿®æ”¹è¯¥å±æ€§æ—¶ä¼šè§¦å‘ setter æ–¹æ³•ã€‚

ä¸‹é¢æˆ‘ä»¬ä»æºç çš„è§’åº¦åˆ†æ vue çš„å“åº”å¼åŸç†ã€‚

## observe

åœ¨ Vue å®ä¾‹åŒ–è¿‡ç¨‹ä¸­ï¼Œ åœ¨ `initData` æ–¹æ³•ä¸­è°ƒç”¨äº† `  observe(data, true /* asRootData */)`

```js
function initData (vm: Component) {
  ...
  // observe data
  observe(data, true /* asRootData */)
}
```

`src/core/observer/index.js`ä¸­ï¼š

```js
export function observe (value: any, asRootData: ?boolean): Observer | void {
  // å¦‚æœä¼ å…¥çš„å‚æ•°ä¸æ˜¯å¯¹è±¡æˆ–è€…æ˜¯VNodeï¼Œç›´æ¥è¿”å›
  if (!isObject(value) || value instanceof VNode) {
    return
  }
  let ob: Observer | void
  // å¦‚æœä¼ å…¥çš„å¯¹è±¡å·²ç»æ˜¯å“åº”
  if (hasOwn(value, '__ob__') && value.__ob__ instanceof Observer) {
    ob = value.__ob__
  } else if (
    shouldObserve &&
    !isServerRendering() &&
    (Array.isArray(value) || isPlainObject(value)) &&
    Object.isExtensible(value) &&
    !value._isVue
  ) {
    // å®ä¾‹åŒ– Observer å¯¹è±¡
    ob = new Observer(value)
  }
  if (asRootData && ob) {
    ob.vmCount++
  }
  return ob
}
```

`observe` æ–¹æ³•çš„ä½œç”¨å°±æ˜¯ç»™é VNode çš„å¯¹è±¡ç±»å‹æ•°æ®æ·»åŠ ä¸€ä¸ª `Observer`ï¼Œå¦‚æœå·²ç»æ·»åŠ è¿‡åˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™åœ¨æ»¡è¶³ä¸€å®šæ¡ä»¶ä¸‹å»å®ä¾‹åŒ–ä¸€ä¸ª `Observer` å¯¹è±¡å®ä¾‹ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ `Observer` çš„ä½œç”¨ã€‚

## Observer

Observer æ˜¯ä¸€ä¸ªç±»ï¼Œå®ƒçš„ä½œç”¨æ˜¯ç»™å¯¹è±¡çš„å±æ€§æ·»åŠ  getter å’Œ setterï¼Œç”¨äºä¾èµ–æ”¶é›†å’Œæ´¾å‘æ›´æ–°ã€‚

`src/core/observer/index.js`ä¸­ï¼š

```js

/**
 * Observer class that is attached to each observed
 * object. Once attached, the observer converts the target
 * object's property keys into getter/setters that
 * collect dependencies and dispatch updates.
 */
export class Observer {
  value: any;
  dep: Dep;
  vmCount: number; // number of vms that have this object as root $data

  constructor (value: any) {
    this.value = value
    this.dep = new Dep()
    this.vmCount = 0
    def(value, '__ob__', this)
    // å¦‚æœä¼ å…¥çš„å‚æ•°æ˜¯æ•°ç»„
    if (Array.isArray(value)) {
      // å¦‚è¿‡æœ‰åŸå‹ __proto__
      if (hasProto) {
        protoAugment(value, arrayMethods)
      } else {
        copyAugment(value, arrayMethods, arrayKeys)
      }
      // observe æ•°ç»„
      this.observeArray(value)
    } else {
      this.walk(value)
    }
  }

  /**
   * Walk through all properties and convert them into
   * getter/setters. This method should only be called when
   * value type is Object.
   */
  walk (obj: Object) {
    const keys = Object.keys(obj)
    for (let i = 0; i < keys.length; i++) {
      defineReactive(obj, keys[i])
    }
  }

  /**
   * Observe a list of Array items.
   */
  observeArray (items: Array<any>) {
    for (let i = 0, l = items.length; i < l; i++) {
      observe(items[i])
    }
  }
}

```

`Observer`çš„é€»è¾‘æ˜¯ï¼š

- å®ä¾‹åŒ– `Dep` å¯¹è±¡
- æ‰§è¡Œ `def`å‡½æ•°æŠŠè‡ªèº«å®ä¾‹ï¼ˆthisï¼‰æ·»åŠ åˆ°æ•°æ®å¯¹è±¡ `value` å’Œ `__ob__`å±æ€§ä¸Š
- åˆ¤æ–­ `value`ç±»å‹ ï¼Œå¯¹æ•°ç»„è°ƒç”¨ `observeArray`ï¼ˆéå†æ•°ç»„å†æ¬¡è°ƒç”¨`observe`ï¼‰ æ–¹æ³•ï¼Œå¯¹çº¯å¯¹è±¡è°ƒç”¨ `walk`æ–¹æ³•ã€‚
- `walk`è°ƒç”¨ `definReactive`æ–¹æ³•

æ¥ä¸‹æ¥æˆ‘ä»¬ä¸€èµ·çœ‹ä¸€ä¸‹ `def` å’Œ `definReactive`  èƒŒåå‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

## def

`def` çš„ä½œç”¨å°±æ˜¯å®šä¹‰å±æ€§ã€‚

`src/core/util/lang.js`ä¸­ï¼š

```js
/**
 * Define a property.
 */
export function def (obj: Object, key: string, val: any, enumerable?: boolean) {
  Object.defineProperty(obj, key, {
    value: val,
    enumerable: !!enumerable,
    writable: true,
    configurable: true
  })
}
```

## defineReactive

`defineReactive` çš„ä½œç”¨æ˜¯ç»™å¯¹è±¡å®šä¹‰å“åº”å¼å±æ€§ã€‚

`src/core/observer/index.js`ä¸­ï¼š

```js
/**
 * Define a reactive property on an Object.
 */
export function defineReactive (
  obj: Object,
  key: string,
  val: any,
  customSetter?: ?Function,
  shallow?: boolean
) {
  // åˆ›å»º Dep å®ä¾‹ï¼Œç”¨æ¥æ”¶é›†ä¾èµ–
  const dep = new Dep()
	
  // è·å– obj å¯¹è±¡çš„å±æ€§æè¿°
  const property = Object.getOwnPropertyDescriptor(obj, key)
  // å¦‚æœ obj å¯¹è±¡å±æ€§æè¿°ä¸å¯æ›´æ”¹
  if (property && property.configurable === false) {
    return
  }
	
	// å¦‚æœä¹‹å‰è¯¥å¯¹è±¡å·²ç»é¢„è®¾äº†getterä»¥åŠsetterå‡½æ•°åˆ™å°†å…¶å–å‡ºæ¥ï¼Œæ–°å®šä¹‰çš„getter/setterä¸­ä¼šå°†å…¶æ‰§è¡Œï¼Œä¿è¯ä¸ä¼šè¦†ç›–ä¹‹å‰å·²ç»å®šä¹‰çš„getter/setter
  // cater for pre-defined getter/setters
  const getter = property && property.get
  const setter = property && property.set
  if ((!getter || setter) && arguments.length === 2) {
    val = obj[key]
  }
  
  // å¯¹è±¡çš„å­å¯¹è±¡é€’å½’è¿›è¡Œobserveå¹¶è¿”å›å­èŠ‚ç‚¹çš„Observerå¯¹è±¡
  let childOb = !shallow && observe(val)
  Object.defineProperty(obj, key, {
    enumerable: true,
    configurable: true,
    get: function reactiveGetter () {
      // å¦‚æœåŸæœ¬å¯¹è±¡æ‹¥æœ‰getteræ–¹æ³•åˆ™æ‰§è¡Œ
      const value = getter ? getter.call(obj) : val
      if (Dep.target) {
        // ä¾èµ–æ”¶é›†
        dep.depend()
        if (childOb) {
          // å­å¯¹è±¡è¿›è¡Œä¾èµ–æ”¶é›†
          childOb.dep.depend()
          // å¦‚æœ val å€¼æ˜¯æ•°ç»„
          if (Array.isArray(value)) {
            // å¯¹æ•°ç»„æ¯ä¸€ä¸ªå€¼éƒ½è¿›è¡Œä¾èµ–æ”¶é›†
            dependArray(value)
          }
        }
      }
      return value
    },
    set: function reactiveSetter (newVal) {
      // é€šè¿‡ getter æ–¹æ³•è·å–å½“å‰å€¼ï¼Œä¸æ–°å€¼è¿›è¡Œæ¯”è¾ƒï¼Œä¸€è‡´åˆ™ä¸éœ€è¦æ‰§è¡Œä¸‹é¢çš„æ“ä½œ
      const value = getter ? getter.call(obj) : val
      /* eslint-disable no-self-compare */
      if (newVal === value || (newVal !== newVal && value !== value)) {
        return
      }
      /* eslint-enable no-self-compare */
      if (process.env.NODE_ENV !== 'production' && customSetter) {
        customSetter()
      }
      // #7981: for accessor properties without setter
      if (getter && !setter) return
      if (setter) {
        // å¦‚æœ obj åŸæœ¬æ‹¥æœ‰ setter æ–¹æ³•åˆ™æ‰§è¡ŒåŸæœ¬ setter
        setter.call(obj, newVal)
      } else {
        val = newVal
      }
			// æ–°çš„å€¼éœ€è¦é‡æ–°è¿›è¡Œobserveï¼Œä¿è¯æ•°æ®å“åº”å¼
      childOb = !shallow && observe(newVal)
      // é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…ï¼Œå†…éƒ¨è°ƒç”¨ watcher çš„ update æ–¹æ³•
      dep.notify()
    }
  })
}
```

`defineReactive` å‡½æ•°æœ€å¼€å§‹åˆå§‹åŒ– `Dep` å¯¹è±¡çš„å®ä¾‹ï¼Œæ¥ç€æ‹¿åˆ° `obj` çš„å±æ€§æè¿°ç¬¦ï¼Œç„¶åå¯¹å­å¯¹è±¡é€’å½’è°ƒç”¨ `observe` æ–¹æ³•ï¼Œè¿™æ ·å°±ä¿è¯äº†æ— è®º `obj` çš„ç»“æ„å¤šå¤æ‚ï¼Œå®ƒçš„æ‰€æœ‰å­å±æ€§ä¹Ÿèƒ½å˜æˆå“åº”å¼çš„å¯¹è±¡ï¼Œè¿™æ ·æˆ‘ä»¬è®¿é—®æˆ–ä¿®æ”¹ `obj` ä¸­ä¸€ä¸ªåµŒå¥—è¾ƒæ·±çš„å±æ€§ï¼Œä¹Ÿèƒ½è§¦å‘ getter å’Œ setterã€‚æœ€ååˆ©ç”¨ `Object.defineProperty` å»ç»™ `obj` çš„å±æ€§ `key` æ·»åŠ  getter å’Œ setterã€‚

å…¶ä¸­ getter æ–¹æ³•ï¼š

1. å…ˆä¸ºæ¯ä¸ª data å£°æ˜ä¸€ä¸ª **`Dep`** å®ä¾‹å¯¹è±¡ï¼Œè¢«ç”¨äº getter æ—¶æ‰§è¡Œ `dep.depend()` è¿›è¡Œæ”¶é›†ç›¸å…³çš„ä¾èµ–

2. æ ¹æ® `Dep.target` æ¥åˆ¤æ–­æ˜¯å¦æ”¶é›†ä¾èµ–ï¼Œè¿˜æ˜¯æ™®é€šå–å€¼

å…¶ä¸­ setter æ–¹æ³•ä¸­:

1. è·å–æ–°çš„å€¼å¹¶ä¸”è¿›è¡Œ `observe`ï¼Œä¿è¯æ•°æ®å“åº”å¼
2. æ‰§è¡Œ `dep.notify()` é€šçŸ¥æ‰€æœ‰è®¢é˜…è€…æ›´æ–°æ•°æ®ï¼Œä»è€Œè¾¾åˆ°å“åº”å¼


## æ€»ç»“

å“åº”å¼å¯¹è±¡æ ¸å¿ƒå°±æ˜¯åˆ©ç”¨ `Object.defineProperty` ç»™æ•°æ®æ·»åŠ äº† getter å’Œ setterï¼Œç›®çš„å°±æ˜¯ä¸ºäº†åœ¨æˆ‘ä»¬è®¿é—®æ•°æ®ä»¥åŠå†™æ•°æ®çš„æ—¶å€™èƒ½è‡ªåŠ¨æ‰§è¡Œä¸€äº›é€»è¾‘ï¼šgetter åšçš„äº‹æƒ…æ˜¯ä¾èµ–æ”¶é›†ï¼Œsetter åšçš„äº‹æƒ…æ˜¯æ´¾å‘æ›´æ–°


![](https://user-gold-cdn.xitu.io/2019/12/19/16f1d834a61e8444?w=380&h=561&f=png&s=23647)