

# Vue.js æºç åˆ†æä¸€ï¼šVue å®ä¾‹åŒ–è¿‡ç¨‹

> æœ¬æ–‡åˆ†æçš„ Vue æºç ç‰ˆæœ¬æ˜¯ 2.6.10

Vue å®˜ç½‘ç¬¬ä¸€ä¸ªğŸŒ°å°±æ˜¯ï¼š

```js
var app = new Vue({
  el: '#app',
  data: {
    message: 'Hello Vue!'
  }
})
```

é€šè¿‡`new`çš„æ–¹å¼åˆ›å»ºäº†ä¸€ä¸ª`Vue`çš„å®ä¾‹ `app`ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ª`Vue`åˆ°åº•åšäº†ä»€ä¹ˆ?

## new Vue

`src/core/instance/index.js`ä¸­ï¼š

```js
function Vue (options) {
  if (process.env.NODE_ENV !== 'production' &&
    !(this instanceof Vue)
  ) {
    warn('Vue is a constructor and should be called with the `new` keyword')
  }
  // éå¸¸é‡è¦
  this._init(options)
}
```

æˆ‘ä»¬å¯ä»¥çœ‹åˆ° `Vue` é€šè¿‡ `new` å…³é”®å­—åˆå§‹åŒ–ï¼Œç„¶åè°ƒç”¨ **`this._init`** æ–¹æ³•

### this._init()

`src/core/instance/init.js`ä¸­ï¼š

``` js
  Vue.prototype._init = function (options?: Object) {
    // merge options
    if (options && options._isComponent) {
      // optimize internal component instantiation
      // since dynamic options merging is pretty slow, and none of the
      // internal component options needs special treatment.
      initInternalComponent(vm, options)
    } else {
      vm.$options = mergeOptions(
        resolveConstructorOptions(vm.constructor),
        options || {},
        vm
      )
    }
  	...
    // åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸ
    initLifecycle(vm) 
    // åˆå§‹åŒ–äº‹ä»¶ä¸­å¿ƒ
    initEvents(vm) 
    // åˆå§‹åŒ–æ¸²æŸ“
    initRender(vm) 
    // è°ƒç”¨beforeCreateé’©å­å‡½æ•°
    callHook(vm, 'beforeCreate')
    // åˆå§‹åŒ–inject
    initInjections(vm) // resolve injections before data/props
    // åˆå§‹åŒ–çŠ¶æ€
    initState(vm)
    // åˆå§‹åŒ–provide
    initProvide(vm) // resolve provide after data/props
    // è°ƒç”¨ceatedé’©å­å‡½æ•°
    callHook(vm, 'created')
    ...
    // æ£€æµ‹åˆ°å¦‚æœæœ‰ el å±æ€§ï¼Œåˆ™è°ƒç”¨ vm.$mount æ–¹æ³•æŒ‚è½½ vmï¼ŒæŒ‚è½½çš„ç›®æ ‡å°±æ˜¯æŠŠæ¨¡æ¿æ¸²æŸ“æˆæœ€ç»ˆçš„ DOM
    if (vm.$options.el) {
      vm.$mount(vm.$options.el)
    }
  }
```

æ­¤æ®µä»£ç å¯¹åº”çš„æ˜¯[ç”Ÿå‘½å‘¨æœŸå›¾ç¤º](https://cn.vuejs.org/v2/guide/instance.html#ç”Ÿå‘½å‘¨æœŸå›¾ç¤º)

![](https://user-gold-cdn.xitu.io/2019/12/17/16f12d95d0ff3e5c?w=1226&h=694&f=png&s=71491)

æ¥ä¸‹æ¥æˆ‘ä»¬è¯¦ç»†åˆ†æä¸€ä¸‹ `Vue` çš„åˆå§‹åŒ–è¿‡ç¨‹

###  åˆå§‹åŒ–è¿‡ç¨‹


![](https://user-gold-cdn.xitu.io/2019/12/18/16f17f28a9128b26?w=600&h=443&f=png&s=36207)

1. åˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸï¼ˆæŒ‚è½½ç§æœ‰å±æ€§ï¼‰

   `src/core/instance/lifecycle.js`ä¸­ï¼š

   ```js
   export function initLifecycle (vm: Component) {
     const options = vm.$options
   
     // locate first non-abstract parent
     // åœ¨keep-aliveä¸­ï¼Œä¼šè®¾ç½® abstract: true å±æ€§ï¼ŒVue ä¼šè·³è¿‡è¯¥ç»„ä»¶å®ä¾‹
     let parent = options.parent
     if (parent && !options.abstract) {
       while (parent.$options.abstract && parent.$parent) {
         parent = parent.$parent
       }
       parent.$children.push(vm)
     }
     // ä¸ºç»„ä»¶å®ä¾‹æŒ‚è½½ç›¸åº”å±æ€§ï¼Œå¹¶åˆå§‹åŒ–
     vm.$parent = parent
     vm.$root = parent ? parent.$root : vm
   
     vm.$children = []
     vm.$refs = {}
     // watcher å®ä¾‹å¯¹è±¡
     vm._watcher = null
     // keep-alive ç»„ä»¶æ¿€æ´»çŠ¶æ€
     vm._inactive = null
     // keep-alive ç»„ä»¶çŠ¶æ€å±æ€§
     vm._directInactive = false
     // å®ä¾‹æ˜¯å¦å®ŒæˆæŒ‚è½½(å¯¹åº”ç”Ÿå‘½å‘¨æœŸå›¾ç¤ºä¸­çš„mounted)
     vm._isMounted = false
     // å®ä¾‹æ˜¯å¦å®Œæˆé”€æ¯(å¯¹åº”ç”Ÿå‘½å‘¨æœŸå›¾ç¤ºä¸­çš„destroyed)
     vm._isDestroyed = false
     // å®ä¾‹æ˜¯å¦æ­£åœ¨é”€æ¯(ä»‹äºç”Ÿå‘½å‘¨æœŸå›¾ç¤ºä¸­deforeDestroyå’Œdestroyedä¹‹é—´)
     vm._isBeingDestroyed = false
   }
   ```
   
2. åˆå§‹åŒ–äº‹ä»¶ä¸­å¿ƒ

   `src/core/instance/events.js`

   ```js 
   export function initEvents (vm: Component) {
     // åˆ›å»ºäº‹ä»¶å¯¹è±¡ï¼Œå­˜å‚¨äº‹ä»¶
     vm._events = Object.create(null)
     // ç³»ç»Ÿäº‹ä»¶æ ‡è¯†ä½
     vm._hasHookEvent = false
     // init parent attached events
     const listeners = vm.$options._parentListeners
     if (listeners) {
       updateComponentListeners(vm, listeners)
     }
   }
   ```

3. åˆå§‹åŒ–æ¸²æŸ“ï¼ˆåˆå§‹åŒ–`$slot` ã€ `$createElement`ã€`$attrs`ã€`$listeners` ç­‰æ¸²æŸ“å±æ€§ï¼‰

   `src/core/instance/render.js`ä¸­ï¼š

   ```js
   export function initRender (vm: Component) {
     ...
     // å¤„ç†ç»„ä»¶slotï¼Œè¿”å›slotæ’æ§½å¯¹è±¡
     vm.$slots = resolveSlots(options._renderChildren, renderContext)
     vm.$scopedSlots = emptyObject
     // bind the createElement fn to this instance
     // so that we get proper render context inside it.
     // args order: tag, data, children, normalizationType, alwaysNormalize
     // internal version is used by render functions compiled from templates
     vm._c = (a, b, c, d) => createElement(vm, a, b, c, d, false)
     // normalization is always applied for the public version, used in
     // user-written render functions.
     vm.$createElement = (a, b, c, d) => createElement(vm, a, b, c, d, true)
     
     // $attrs & $listeners are exposed for easier HOC creation.
     // they need to be reactive so that HOCs using them are always updated
     const parentData = parentVnode && parentVnode.data
   
     /* istanbul ignore else */
     if (process.env.NODE_ENV !== 'production') {
   	 ...
     } else {
       defineReactive(vm, '$attrs', parentData && parentData.attrs || emptyObject, null, true)
       defineReactive(vm, '$listeners', options._parentListeners || emptyObject, null, true)
     }
   }
   ```
   
4. è°ƒç”¨äº†`beforeCreate`é’©å­å‡½æ•°

5. åˆå§‹åŒ– inject ï¼ˆçŠ¶æ€åˆå§‹åŒ–ä¹‹å‰ï¼‰

   `src/core/instance/inject.js`ä¸­ï¼š

   ```js
   export function initInjections (vm: Component) {
     const result = resolveInject(vm.$options.inject, vm)
     if (result) {
       toggleObserving(false)
       Object.keys(result).forEach(key => {
         /* istanbul ignore else */
         if (process.env.NODE_ENV !== 'production') {
           defineReactive(vm, key, result[key], () => {
             warn(
               `Avoid mutating an injected value directly since the changes will be ` +
               `overwritten whenever the provided component re-renders. ` +
               `injection being mutated: "${key}"`,
               vm
             )
           })
         } else {
           defineReactive(vm, key, result[key])
         }
       })
       toggleObserving(true)
     }
   }
   ```

   

6. **åˆå§‹åŒ–çŠ¶æ€**

   åœ¨è¿™é‡Œæˆ‘ä»¬ä¸è¯¦ç»†åˆ†æ `inState`æ–¹æ³•ï¼Œè¯¦ç»†åˆ†æè¯·çœ‹[ã€ŠVue.js æºç åˆ†æäºŒï¼šinitState åŸç†ã€‹](https://takkitang.github.io/vuesource/2.html)ã€‚

   `initState` æ–¹æ³•ä¸»è¦æ˜¯å¯¹ `props`ã€`methods`ã€`data`ã€`computed` å’Œ `wathcer` ç­‰å±æ€§åšäº†åˆå§‹åŒ–æ“ä½œã€‚

7. åˆå§‹åŒ– provideï¼ˆçŠ¶æ€åˆå§‹åŒ–ä¹‹åï¼‰

   `src/core/instance/inject.js`ä¸­ï¼š

   ```js
   export function initProvide (vm: Component) {
     const provide = vm.$options.provide
     if (provide) {
       vm._provided = typeof provide === 'function'
         ? provide.call(vm)
         : provide
     }
   }
   ```

8. è°ƒç”¨äº†`created`é’©å­å‡½æ•°



## æ€»ç»“

Vue åˆå§‹åŒ–ä¸»è¦å°±å¹²äº†å‡ ä»¶äº‹æƒ…ï¼Œåˆå¹¶é…ç½®ï¼Œåˆå§‹åŒ–ç”Ÿå‘½å‘¨æœŸï¼Œåˆå§‹åŒ–äº‹ä»¶ä¸­å¿ƒï¼Œåˆå§‹åŒ–æ¸²æŸ“ï¼Œåˆå§‹åŒ–çŠ¶æ€ã€‚




